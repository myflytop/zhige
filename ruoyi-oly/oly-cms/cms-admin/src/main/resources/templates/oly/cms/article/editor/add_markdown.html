<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<th:block th:include="oly/cms/article/article_add_include :: addHead" />
	<th:block th:include="include :: oly_markdown_css" />
</head>

<body class="white-bg">
	<h1 style="display: inline-block;padding-left: 10px;">添加文章</h1>
	
	<th:block th:include="oly/cms/article/article_add_include :: addForm(edit='mark')" />
     
	<th:block th:include="oly/cms/article/article_add_include :: addFooter" />
	
	<th:block th:include="include :: oly_markdown_js" />
	
	<script th:inline="JavaScript">
		var prefix = ctx + "cms/article",
			tagPrefix = ctx + "cms/tag",
			catPrefix = ctx + "cms/cat",
			maxTag = [[${@configTag.getKey('cmsConfig','oly.cms.articleTag.maxNum') }]],
		maxCat = [[${@configTag.getKey('cmsConfig','oly.cms.articleCat.maxNum') }]],
		maxPhoto = [[${@configTag.getKey('cmsConfig','oly.cms.articleImg.maxNum') }]],
		maxKeyword = [[${@configTag.getKey('cmsConfig','oly.cms.articleKeyword.maxNum') }]];
		//初始化标签
		$("#tagInput").tagsinput({
			maxTags: maxTag,
			itemValue: 'tagId',
			itemText: 'tagName'
		});

		//初始化文章分类
		$("#catInput").tagsinput({
			maxTags: maxCat,
			itemValue: 'catId',
			itemText: 'catName'
		});

		//文章关键词
		$("#articleKey").tagsinput({
			maxTags: maxKeyword,
			maxChars: 8
		});
		// 选择标签
		$("#chooseTag").change(function () {
			var k = $(this).val();
			var n = $(this).find("option:selected").text().split("(")[0];
			if (n != "") {
				$("#tagInput").tagsinput('add', {
					'tagId': k,
					'tagName': n
				});
			}
		});

		//获取标签列表
		function getTag() {
			$.get(tagPrefix + "/listTagNotHide", function (data, status) {
				$("#chooseTag").empty();
				$.each(data, function (i, e) { //i是索引，e是json对象
					$("#chooseTag").append("<option value=" + e.tagId + ">" + e.tagName + "(" + ((e.tagCount) === null ? 0 : e.tagCount) +
						")</option>");
				});
				$("#chooseTag").selectpicker("refresh");
			});
		}

		/*文章管理-新增-选择类目树*/
		function selectCatTree() {
			var url = catPrefix + "/selectCatTree?catId=0&visible=1";
			var options = {
				title: '类目选择',
				width: "380",
				url: url,
				callBack: doSubmit
			};
			$.modal.openOptions(options);
		}
		//选择类目回调
		function doSubmit(index, layero) {
			var body = $.modal.getChildFrame(index);
			var catId = body.find('#treeId').val();
			var catName = body.find('#treeName').val();
			$("#treeName").val(catName);
			$("#catInput").tagsinput('add', {
				'catId': catId,
				'catName': catName
			});
			$.modal.close(index);
		};
		/* 添加分类 */
		function addCat() {
			$.modal.open('添加分类', catPrefix + "/add/0");
		}
		/* 添加标签 */
		function addTag() {
			$.modal.open('添加标签', tagPrefix + "/add");
		}
		//初始化标签
		$(window).on('load', function () {
			//初始化标签下拉框
			$('#chooseTag').selectpicker();
			getTag();
		});

		/* 初始化富文本编辑器 */
		var editor = editormd("editor", {
			width: "100%",
			height: 740,
			path: '/ajax/libs/oly_markdown/lib/',
			theme: "dark",
			previewTheme: "dark",
			editorTheme: "pastel-on-dark",
			markdown: '',
			codeFold: true,
			//syncScrolling : false,
			saveHTMLToTextarea: true,    // 保存 HTML 到 Textarea
			searchReplace: true,
			//watch : false,                // 关闭实时预览
			htmlDecode: "style,script,iframe|on*",            // 开启 HTML 标签解析，为了安全性，默认不开启    
			//toolbar  : false,             //关闭工具栏
			//previewCodeHighlight : false, // 关闭预览 HTML 的代码块高亮，默认开启
			emoji: true,
			taskList: true,
			tocm: true,         // 生成TOCM]
			toc: true,           // 生成[TOC]
			tocTitle: "目录",
			tex: true,                   // 开启科学公式TeX语言支持，默认关闭
			flowChart: true,             // 开启流程图支持，默认关闭
			sequenceDiagram: true,       // 开启时序/序列图支持，默认关闭,
			//dialogLockScreen : false,   // 设置弹出层对话框不锁屏，全局通用，默认为true
			//dialogShowMask : false,     // 设置弹出层对话框显示透明遮罩层，全局通用，默认为true
			//dialogDraggable : false,    // 设置弹出层对话框不可拖动，全局通用，默认为true
			//dialogMaskOpacity : 0.4,    // 设置透明遮罩层的透明度，全局通用，默认值为0.1
			//dialogMaskBgColor : "#000", // 设置透明遮罩层的背景颜色，全局通用，默认为#fff
			imageUpload: true,
			imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
			imageUploadURL: prefix + '/articleImgByMarkdown',
			onload: function () {
				//this.fullscreen();
				//this.unwatch();
				//this.watch().fullscreen();

				//this.setMarkdown("#PHP");
				//this.width("100%");
				//this.height(480);
				//this.resize("100%", 640);
			}
		});

		/* 文章验证 */
		$("#form-article-add").validate({
			errorPlacement: function (error, element) {
				layer.tips(error.html(), element, {
					tipsMore: true
				});
			},
			rules: {
				articleType: {
					required: true
				},
				allowComment: {
					required: true
				},
				articleTitle: {
					required: true,
					rangelength:[2,32],
					remote: {
						url: prefix + "/checkArticleUnique",
						type: "post",
						dataType: "json",
						data: {
							"articleTitle": function () {
								if ($("#catInput").val().length != null) {
									return $.common.trim($("#articleTitle").val());
								} else {
									layer.msg('类别未选', {
										icon: 1,
										time: 1000 //2秒关闭（如果不配置，默认是3秒）
									}, function () {
										layer.closeAll();
									});
									return;
								}
							}
						},
						dataFilter: function (data, type) {
							return $.validate.unique(data);
						}
					}
				},
				articleUrl: {
					required: true,
					remote: {
						url: prefix + "/checkArticleUnique",
						type: "post",
						dataType: "json",
						data: {
							"articleUrl": function () {
								return $.common.trim($("#articleUrl").val());
							}
						},
						dataFilter: function (data, type) {
							if (data == "0") {
								$("#relativeUrl").text($("#articleUrl").val());
							}
							return $.validate.unique(data);
						}
					}
				}
			},
			messages: {
				"articleTitle": {
					remote: "文章标题已经存在"
				},
				"articleUrl": {
					remote: "文章路径已经存在"
				}
			},
			focusCleanup: true
		});

		/* 进入保存按钮 */
		$("#add-btn").click(function () {
			if ($("input[name='cats']").val() === '') {
				layer.msg('请选择一个分类', {
					icon: 6
				})
			} else if ($.validate.form("form-article-add")) {
				//获取编辑内容
				let editorData = editor.getPreviewedHTML();
				let editMark = editor.getMarkdown();
				layer.open({
					title: "确认信息",
					area: ['600px', '400px'],
					type: 1,
					content: $("#addTemplate").html(),
					success: function () {
						//填充图片
						var imgs = chooseImg(editorData);
						if (imgs.length > 0) {
							$.each(imgs, function (i, val) {
								$("#chooseImgBox").append("<img class='ophide' src='" + val + "' />")
							})
						}
						//填充描述
						$("#articleSummary").val(chooseSummary(editorData).slice(0, 160));
						//初始化选择事件
						$("#chooseImgBox>img").click(function () {
							if ($(this).hasClass("opshow")) {
								$(this).removeClass("opshow");
								$(this).addClass("ophide");
								return;
							}
							if ($(this).hasClass("ophide") && $(".opshow").length < maxPhoto) {
								$(this).removeClass("ophide");
								$(this).addClass("opshow");
								return;
							} else {
								layer.msg('最多选择' + maxPhoto + '张', {
									icon: 6
								})
							}
						});
						//保存文章
						$("#saveArticle").click(function () {			
							$("#edit").remove();	
							let data = $('#form-article-add').serializeArray();
							data.push({ "name": "articleImg", "value": getImgSrc($(".opshow")).join(",") });
							data.push({ "name": "articleMd", "value": editMark });
							data.push({ "name": "articleContent", "value": editorData });
							data.push({ "name": "articleBuild", "value": 1 });
							data.push({ "name": "articleSummary", "value": $("#articleSummary").val()});
							console.log(data);
							$.operate.saveTab(prefix + "/add",data);
							layer.closeAll();
						});
					}
				});
			} else {
				layer.msg('表单验证未通过', {
					icon: 6
				});
			}
		});
		//截取图片
		function getImgSrc(dom) {
			var srcs = [];
			$.each(dom, function (i, val) {
				srcs.push($(this).attr("src"))
			});
			return srcs;
		}

		//获取上传的图片
		function chooseImg(str) {
			var data = []
			//获取img标签
			var imgReg = /<img.*?(?:>|\/>)/gi;
			//匹配src属性
			var srcReg = /src=[\'\"]?([^\'\"]*)[\'\"]?/i;
			var arr = str.match(imgReg);
			if (arr == null) {
				return data;
			}
			for (var i = 0; i < arr.length; i++) {
				var src = arr[i].match(srcReg);
				//获取图片地址
				if (src[1]) {
					data.push(src[1]);
				}
			}
			return data;
		}

		//文章预览
		function chooseSummary(html) {
			html = html.replace(/<\/?[^>]*>/g, ''); //去除HTML tag
			html = html.replace(/[ | ]*\n/g, '\n'); //去除行尾空白
			html = html.replace(/ /ig, ''); //去掉
			return html;
		}
		function autoComplateUrl() {
			var articleUrl = $("#articleUrl");
			if (articleUrl.html() === '') {
				var g = new Date().getTime();
				$("input[name='articleUrl']").val(g);
				$("#relativeUrl").html("/" + g);
			}
		}
		//初始化填充
		autoComplateUrl();
	</script>
</body>

</html>